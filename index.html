<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
</head>

<body>
  <script>
    const KEY_USER_ID = 'userId';

    getId().then(id => {
      const message = {
        event: "getId",
        value: id,
      };

      parent.postMessage(JSON.stringify(message), "*");
    });



    function getId() {
      if (isSafari()) {
        console.log('safari');
        return getIdFromFingerprint();
      }

      let id = localStorage.getItem(KEY_USER_ID);
      if (!id) {
        id = uuidv4();
        localStorage.setItem(KEY_USER_ID, id);
      }

      return Promise.resolve(id);
    }


    function isSafari() { return /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && window['safari'].pushNotification)); }

    function getIdFromFingerprint() {
      const id = localStorage.getItem(KEY_USER_ID);

      if (id) return Promise.resolve(id);

      return import('https://fpcdn.io/v3/1ItjaKwplSsZ3CpiS7pJ')
        .then(FingerprintJS => FingerprintJS.load())
        .then(fp => fp.get())
        .then(result => {
          localStorage.setItem(KEY_USER_ID, result.visitorId);
          return result.visitorId
        });
    }


    function uuidv4() {
      let date = new Date().getTime();
      let date2 = (performance && performance.now && (performance.now() * 1000)) || 0;
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (match) => {
        let random = Math.random() * 16;
        if (date > 0) {
          random = (date + random) % 16 | 0;
          date = Math.floor(date / 16);
        } else {
          random = (date2 + random) % 16 | 0;
          date2 = Math.floor(date2 / 16);
        }
        return (match === 'x' ? random : (random & 0x3 | 0x8)).toString(16);
      });
    }    
  </script>
</body>

</html>